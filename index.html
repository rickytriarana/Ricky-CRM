<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#1f2a44" />
  <title>Arana CRM (Offline PWA)</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{
      --text:#e5e7eb; --muted:#94a3b8; --line:#24314f;
      --primary:#3b82f6; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:linear-gradient(180deg,#0b1022,#070a14);
      color:var(--text);
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;border-bottom:1px solid var(--line);
      background:rgba(15,23,42,.75);backdrop-filter: blur(10px);
      position:sticky;top:0;z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,#1d4ed8,#60a5fa);font-weight:700;
    }
    .appname{font-weight:700}
    .subtitle{font-size:12px;color:var(--muted)}
    .tabs{
      display:flex;gap:6px;padding:10px;border-bottom:1px solid var(--line);
      background:rgba(15,23,42,.55);position:sticky;top:59px;z-index:9;
    }
    .tab{flex:1;padding:10px 8px;border:1px solid var(--line);background:transparent;color:var(--text);
      border-radius:12px;cursor:pointer}
    .tab.active{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.35)}
    .container{max-width:960px;margin:0 auto;padding:14px}
    .panel{display:none}.panel.active{display:block}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
    .rowcol{display:flex;flex-direction:column;gap:8px}
    .rowcol.right{align-items:flex-end}
    .label{font-size:12px;color:var(--muted)}
    .input{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(17,27,52,.7);color:var(--text)
    }
    .inputfile{
      width:100%;padding:10px;border-radius:12px;border:1px dashed var(--line);
      background:rgba(17,27,52,.35);color:var(--muted)
    }
    button{
      border:1px solid var(--line);background:rgba(17,27,52,.7);color:var(--text);
      padding:12px;border-radius:12px;cursor:pointer
    }
    button.primary{background:rgba(59,130,246,.25);border-color:rgba(59,130,246,.45)}
    button.danger{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.45)}
    button.ghost{background:transparent}
    button:disabled{opacity:.45;cursor:not-allowed}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:transparent;cursor:pointer;font-size:13px}
    .chip.active{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.35)}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .list.compact{gap:6px}
    .item{
      border:1px solid var(--line);background:rgba(17,27,52,.55);border-radius:14px;padding:12px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px
    }
    .itemTitle{font-weight:650}
    .itemSub{font-size:12px;color:var(--muted);margin-top:4px}
    .itemRight{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .badge{font-size:11px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    .card{border:1px solid var(--line);background:rgba(11,18,38,.6);border-radius:16px;padding:14px;margin:12px 0}
    .cardTitle{font-weight:700}
    .cardSub{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
    .empty{border:1px dashed var(--line);border-radius:16px;padding:18px;text-align:center;color:var(--muted)}
    .emptyTitle{color:var(--text);font-weight:650}
    .hidden{display:none !important}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}}
    .seg{display:flex;gap:6px}.segbtn{flex:1}
    .segbtn.active{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.35)}
    /* JS health banner */
    #jsBanner{
      position:fixed;left:12px;right:12px;bottom:12px;
      border:1px solid rgba(239,68,68,.5);
      background:rgba(239,68,68,.12);
      padding:10px 12px;border-radius:14px;
      z-index:9999;
    }
    #jsBanner b{color:#fecaca}
    code{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:10px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">A</div>
      <div class="titles">
        <div class="appname">Arana CRM</div>
        <div class="subtitle">Offline (PWA) — 1 orang — <b>v4</b></div>
      </div>
    </div>
    <button id="btnSync" class="ghost" title="Reload data">↻</button>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="pipeline">Pipeline</button>
    <button class="tab" data-tab="contacts">Contacts</button>
    <button class="tab" data-tab="closed">Closed</button>
    <button class="tab" data-tab="settings">Settings</button>
  </nav>

  <main class="container">
    <section id="tab-pipeline" class="panel active">
      <div class="row">
        <div class="rowcol">
          <div class="label">Stage</div>
          <div id="stageChips" class="chips"></div>
        </div>
        <div class="rowcol right">
          <button id="btnNewDeal" class="primary">+ Deal</button>
        </div>
      </div>
      <div id="pipelineList" class="list"></div>
      <div id="pipelineEmpty" class="empty hidden">
        <div class="emptyTitle">Kosong di stage ini</div>
        <div class="emptySub">Klik <b>+ Deal</b> untuk menambahkan.</div>
      </div>
    </section>

    <section id="tab-contacts" class="panel">
      <div class="row">
        <input id="contactSearch" class="input" placeholder="Search name/phone/email/company" />
        <button id="btnNewContact" class="primary">+ Contact</button>
      </div>
      <div id="contactsList" class="list"></div>
      <div id="contactsEmpty" class="empty hidden">
        <div class="emptyTitle">Belum ada kontak</div>
        <div class="emptySub">Tambahkan contact atau import CSV/VCF di Settings.</div>
      </div>
    </section>

    <section id="tab-closed" class="panel">
      <div class="row">
        <div class="seg">
          <button class="segbtn active" data-closed="won">Won</button>
          <button class="segbtn" data-closed="lost">Lost</button>
        </div>
      </div>
      <div id="closedList" class="list"></div>
      <div id="closedEmpty" class="empty hidden">
        <div class="emptyTitle">Belum ada data</div>
        <div class="emptySub">Deal yang ditutup akan muncul di sini.</div>
      </div>
    </section>

    <section id="tab-settings" class="panel">
      <div class="card">
        <div class="cardTitle">Pipeline Stages</div>
        <div class="cardSub">Tambah / rename / reorder (custom stage)</div>
        <div id="stagesAdmin" class="list compact"></div>
        <div class="row">
          <input id="newStageName" class="input" placeholder="Nama stage baru" />
          <button id="btnAddStage" class="primary">Add</button>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">Import Contacts (CSV)</div>
        <div class="cardSub">Header disarankan: name, phone, email, company, notes</div>
        <div class="row">
          <input id="csvFile" type="file" accept=".csv,text/csv" class="inputfile" />
          <button id="btnImportCsv" class="primary">Import</button>
        </div>
        <div class="hint">Jika CSV tanpa header, urutan kolom dianggap: name, phone, email, company, notes.</div>
      </div>

      <div class="card">
        <div class="cardTitle">Import Contacts (VCF)</div>
        <div class="cardSub">Langsung dari export kontak HP (.vcf / vCard).</div>
        <div class="row">
          <input id="vcfFile" type="file" accept=".vcf,text/vcard,text/x-vcard" class="inputfile" />
          <button id="btnImportVcf" class="primary">Import</button>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">Backup / Restore</div>
        <div class="cardSub">Export JSON untuk backup, lalu restore jika pindah HP.</div>
        <div class="row">
          <button id="btnExport" class="primary">Export Backup (JSON)</button>
        </div>
        <div class="row">
          <input id="jsonFile" type="file" accept=".json,application/json" class="inputfile" />
          <button id="btnRestore" class="danger">Restore (overwrite)</button>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">Troubleshoot</div>
        <div class="cardSub">
          Jika tombol tidak bisa diklik / stuck, buka:<br/>
          <code>reset.html</code>
        </div>
      </div>
    </section>
  </main>

  <!-- Banner will disappear if JS runs -->
  <div id="jsBanner">
    <b>JavaScript belum jalan.</b> Kalau tombol tidak bisa diklik: buka <code>reset.html</code>, lalu reload.
  </div>

  <!-- Modal container (created by JS) -->
  <div id="modalHost"></div>

<script>
  // Register service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
  }

  // If this script runs, hide banner immediately
  document.getElementById("jsBanner").classList.add("hidden");

  // ----------- App (inline JS) -----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const uid = () => (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : ("id-" + Math.random().toString(16).slice(2) + "-" + Date.now());
  const nowMs = () => Date.now();
  const fmtDate = (ms) => { if(!ms) return ""; const d=new Date(ms); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; };
  const esc = (s)=> (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  const toast = (msg)=>{
    const el=document.createElement("div");
    el.textContent=msg;
    el.style.position="fixed";
    el.style.left="50%";
    el.style.bottom="18px";
    el.style.transform="translateX(-50%)";
    el.style.padding="10px 12px";
    el.style.border="1px solid var(--line)";
    el.style.background="rgba(17,27,52,.92)";
    el.style.borderRadius="12px";
    el.style.zIndex="999";
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 2000);
  };

  class DB {
    constructor(){ this.db=null; }
    open(){
      return new Promise((resolve,reject)=>{
        const req=indexedDB.open("arana_crm_pwa_v4",1);
        req.onupgradeneeded=()=>{
          const db=req.result;
          const mk=(n,k)=> db.createObjectStore(n,{keyPath:k});
          mk("stages","id").createIndex("ord","ord",{unique:false});
          mk("contacts","id").createIndex("updatedAt","updatedAt",{unique:false});
          mk("deals","id").createIndex("updatedAt","updatedAt",{unique:false});
          mk("activities","id").createIndex("createdAt","createdAt",{unique:false});
          mk("stageHistory","id").createIndex("createdAt","createdAt",{unique:false});
        };
        req.onsuccess=()=>{ this.db=req.result; resolve(); };
        req.onerror=()=>reject(req.error);
      });
    }
    tx(names, mode="readonly"){ return this.db.transaction(names, mode); }
    getAll(store, index=null, dir="next"){
      return new Promise((resolve,reject)=>{
        const tx=this.tx([store]);
        const s=tx.objectStore(store);
        if(index){
          const req=s.index(index).openCursor(null,dir);
          const out=[];
          req.onsuccess=()=>{
            const c=req.result;
            if(!c){ resolve(out); return; }
            out.push(c.value); c.continue();
          };
          req.onerror=()=>reject(req.error);
        } else {
          const req=s.getAll();
          req.onsuccess=()=>resolve(req.result||[]);
          req.onerror=()=>reject(req.error);
        }
      });
    }
    put(store,obj){
      return new Promise((resolve,reject)=>{
        const tx=this.tx([store],"readwrite");
        tx.objectStore(store).put(obj);
        tx.oncomplete=()=>resolve();
        tx.onerror=()=>reject(tx.error);
      });
    }
    get(store,id){
      return new Promise((resolve,reject)=>{
        const tx=this.tx([store]);
        const req=tx.objectStore(store).get(id);
        req.onsuccess=()=>resolve(req.result||null);
        req.onerror=()=>reject(req.error);
      });
    }
    clear(store){
      return new Promise((resolve,reject)=>{
        const tx=this.tx([store],"readwrite");
        tx.objectStore(store).clear();
        tx.oncomplete=()=>resolve();
        tx.onerror=()=>reject(tx.error);
      });
    }
  }

  const db=new DB();
  const state={ tab:"pipeline", stageId:null, closedStatus:"won", cache:{stages:[],contacts:[],deals:[],activities:[],stageHistory:[]} };

  async function seedIfEmpty(){
    const stages=await db.getAll("stages","ord","next");
    if(stages.length) return;
    const defaults=[
      {name:"1. Potensial Prospek", ord:0},
      {name:"2. Meet/Discovery", ord:1},
      {name:"3. Proposal/Penawaran", ord:2},
      {name:"4. Follow-up/Negosiasi", ord:3},
    ];
    for(const s of defaults) await db.put("stages",{id:uid(),name:s.name,ord:s.ord});
  }

  async function loadCache(){
    state.cache.stages=await db.getAll("stages","ord","next");
    state.cache.contacts=await db.getAll("contacts","updatedAt","prev");
    state.cache.deals=await db.getAll("deals","updatedAt","prev");
    state.cache.activities=await db.getAll("activities","createdAt","prev");
    state.cache.stageHistory=await db.getAll("stageHistory","createdAt","prev");
    if(!state.stageId && state.cache.stages.length) state.stageId=state.cache.stages[0].id;
  }
  async function refresh(){ await loadCache(); render(); }

  function switchTab(tab){
    state.tab=tab;
    $$(".tab").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
    $$(".panel").forEach(p=>p.classList.toggle("active", p.id===`tab-${tab}`));
    render();
  }

  function renderStageChips(){
    const host=$("#stageChips"); host.innerHTML="";
    for(const s of state.cache.stages){
      const b=document.createElement("button");
      b.className="chip"+(s.id===state.stageId?" active":"");
      b.textContent=s.name;
      b.onclick=()=>{ state.stageId=s.id; render(); };
      host.appendChild(b);
    }
  }

  function renderPipeline(){
    renderStageChips();
    const list=$("#pipelineList"), empty=$("#pipelineEmpty");
    list.innerHTML="";
    const deals=state.cache.deals.filter(d=>d.status==="open" && d.stageId===state.stageId);
    if(!deals.length){ empty.classList.remove("hidden"); return; }
    empty.classList.add("hidden");
    for(const d of deals){
      const contact=d.contactId ? state.cache.contacts.find(c=>c.id===d.contactId) : null;
      const sub=[contact?contact.name:null, d.value?("Value: "+d.value):null, d.expectedCloseAt?("Close: "+fmtDate(d.expectedCloseAt)):null].filter(Boolean).join(" • ");
      const item=document.createElement("div");
      item.className="item";
      item.innerHTML=`
        <div>
          <div class="itemTitle">${esc(d.title)}</div>
          <div class="itemSub">${esc(sub||"-")}</div>
        </div>
        <div class="itemRight">
          <span class="badge">OPEN</span>
          <button class="ghost" type="button">Detail →</button>
        </div>`;
      item.querySelector("button").onclick=()=> openDealModal(d.id);
      list.appendChild(item);
    }
  }

  function renderContacts(){
    const q=($("#contactSearch").value||"").trim().toLowerCase();
    const list=$("#contactsList"), empty=$("#contactsEmpty");
    list.innerHTML="";
    let contacts=state.cache.contacts;
    if(q){
      contacts=contacts.filter(c => (c.name||"").toLowerCase().includes(q) || (c.phone||"").toLowerCase().includes(q) || (c.email||"").toLowerCase().includes(q) || (c.company||"").toLowerCase().includes(q));
    }
    if(!contacts.length){ empty.classList.remove("hidden"); return; }
    empty.classList.add("hidden");
    for(const c of contacts){
      const sub=[c.company,c.phone,c.email].filter(Boolean).join(" • ");
      const item=document.createElement("div");
      item.className="item";
      item.innerHTML=`
        <div>
          <div class="itemTitle">${esc(c.name)}</div>
          <div class="itemSub">${esc(sub||"-")}</div>
        </div>
        <div class="itemRight"><button class="ghost" type="button">Edit →</button></div>`;
      item.querySelector("button").onclick=()=> openContactModal(c.id);
      list.appendChild(item);
    }
  }

  function renderClosed(){
    const list=$("#closedList"), empty=$("#closedEmpty");
    list.innerHTML="";
    const deals=state.cache.deals.filter(d=>d.status===state.closedStatus);
    if(!deals.length){ empty.classList.remove("hidden"); return; }
    empty.classList.add("hidden");
    for(const d of deals){
      const sub=(d.status==="lost") ? (d.lostReason||"-") : (d.wonAt?("Won at: "+fmtDate(d.wonAt)):"-");
      const item=document.createElement("div");
      item.className="item";
      item.innerHTML=`
        <div>
          <div class="itemTitle">${esc(d.title)}</div>
          <div class="itemSub">${esc(sub)}</div>
        </div>
        <div class="itemRight">
          <span class="badge">${d.status.toUpperCase()}</span>
          <button class="ghost" type="button">Detail →</button>
        </div>`;
      item.querySelector("button").onclick=()=> openDealModal(d.id);
      list.appendChild(item);
    }
  }

  function renderStagesAdmin(){
    const host=$("#stagesAdmin"); host.innerHTML="";
    const stages=state.cache.stages;
    for(let i=0;i<stages.length;i++){
      const s=stages[i];
      const row=document.createElement("div");
      row.className="item";
      row.innerHTML=`
        <div><div class="itemTitle">${esc(s.name)}</div><div class="itemSub">Order: ${s.ord}</div></div>
        <div class="itemRight">
          <div style="display:flex;gap:6px;">
            <button class="ghost" type="button" ${i===0?"disabled":""}>↑</button>
            <button class="ghost" type="button" ${i===stages.length-1?"disabled":""}>↓</button>
            <button class="ghost" type="button">Rename</button>
          </div>
        </div>`;
      const btns=row.querySelectorAll("button");
      btns[0].onclick=async()=>{ if(i===0) return; await db.put("stages",{...s,ord:stages[i-1].ord}); await db.put("stages",{...stages[i-1],ord:s.ord}); await refresh(); };
      btns[1].onclick=async()=>{ if(i===stages.length-1) return; await db.put("stages",{...s,ord:stages[i+1].ord}); await db.put("stages",{...stages[i+1],ord:s.ord}); await refresh(); };
      btns[2].onclick=async()=>{ const name=prompt("Rename stage:", s.name); if(!name||!name.trim()) return; await db.put("stages",{...s,name:name.trim()}); await refresh(); };
      host.appendChild(row);
    }
  }

  function render(){
    if(state.tab==="pipeline") renderPipeline();
    if(state.tab==="contacts") renderContacts();
    if(state.tab==="closed") renderClosed();
    if(state.tab==="settings") renderStagesAdmin();
  }

  // Modal (built dynamically, so cannot be stuck on load)
  function closeModal(){
    const host=$("#modalHost");
    host.innerHTML="";
  }
  function openModal(title, bodyHtml){
    const host=$("#modalHost");
    host.innerHTML=`
      <div class="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:14px;z-index:100">
        <div class="modalCard" style="width:min(720px,100%);border:1px solid var(--line);background:rgba(11,18,38,.92);border-radius:18px;box-shadow:0 16px 50px rgba(0,0,0,.35)">
          <div class="modalHead" style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)">
            <div style="font-weight:750">${esc(title||"Modal")}</div>
            <button id="modalClose" class="ghost" type="button">✕</button>
          </div>
          <div class="modalBody" style="padding:14px">${bodyHtml||""}</div>
        </div>
      </div>`;
    $("#modalClose").onclick=closeModal;
    host.querySelector(".modal").addEventListener("click",(e)=>{ if(e.target.classList.contains("modal")) closeModal(); });
  }

  async function openContactModal(contactId){
    const c = contactId ? await db.get("contacts", contactId) : null;
    openModal(contactId ? "Edit Contact" : "New Contact", `
      <div class="grid2">
        <div><div class="label">Name *</div><input id="c_name" class="input" value="${esc(c?c.name:"")}" /></div>
        <div><div class="label">Company</div><input id="c_company" class="input" value="${esc(c?c.company:"")}" /></div>
        <div><div class="label">Phone</div><input id="c_phone" class="input" value="${esc(c?c.phone:"")}" /></div>
        <div><div class="label">Email</div><input id="c_email" class="input" value="${esc(c?c.email:"")}" /></div>
      </div>
      <div style="margin-top:10px">
        <div class="label">Notes</div>
        <textarea id="c_notes" class="input" rows="4">${esc(c?c.notes:"")}</textarea>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button id="btnSaveContact" class="primary" type="button">Save</button>
        <button id="btnCancel" class="ghost" type="button">Cancel</button>
      </div>
    `);
    $("#btnCancel").onclick=closeModal;
    $("#btnSaveContact").onclick=async()=>{
      const name=($("#c_name").value||"").trim();
      if(!name){ toast("Name wajib diisi"); return; }
      const obj={
        id: c?c.id:uid(),
        name,
        phone: ($("#c_phone").value||"").trim()||null,
        email: ($("#c_email").value||"").trim()||null,
        company: ($("#c_company").value||"").trim()||null,
        notes: ($("#c_notes").value||"").trim()||null,
        createdAt: c?c.createdAt:nowMs(),
        updatedAt: nowMs()
      };
      await db.put("contacts",obj);
      closeModal(); await refresh(); toast("Saved");
    };
  }

  function parseCsv(text){
    const rows=[]; let cur="", inQ=false, row=[];
    for(let i=0;i<text.length;i++){
      const ch=text[i], next=text[i+1];
      if(ch === '"'){ if(inQ && next === '"'){ cur+='"'; i++; } else inQ=!inQ; continue; }
      if(!inQ && ch === ","){ row.push(cur); cur=""; continue; }
      if(!inQ && ch === "\n"){ row.push(cur); rows.push(row.map(x=>x.trim())); cur=""; row=[]; continue; }
      if(ch === "\r") continue;
      cur += ch;
    }
    if(cur.length || row.length){ row.push(cur); rows.push(row.map(x=>x.trim())); }
    return rows.filter(r => r.some(x => (x||"").trim()));
  }
  async function importCsvFile(file){
    const text=await file.text();
    const rows=parseCsv(text);
    if(!rows.length){ toast("CSV kosong"); return 0; }
    const first=rows[0].map(x=>(x||"").toLowerCase());
    const hasHeader=first.includes("name")||first.includes("phone")||first.includes("email");
    let header=[], start=0;
    if(hasHeader){ header=first; start=1; }
    let n=0;
    for(let i=start;i<rows.length;i++){
      const r=rows[i];
      let name="", phone="", email="", company="", notes="";
      if(hasHeader){
        const get=(k)=>{ const idx=header.indexOf(k); return (idx>=0 && idx<r.length)?r[idx]:""; };
        name=get("name"); phone=get("phone"); email=get("email"); company=get("company"); notes=get("notes");
      } else {
        name=r[0]||""; phone=r[1]||""; email=r[2]||""; company=r[3]||""; notes=r[4]||"";
      }
      if(!name.trim()) continue;
      await db.put("contacts",{id:uid(),name:name.trim(),phone:phone.trim()||null,email:email.trim()||null,company:company.trim()||null,notes:notes.trim()||null,createdAt:nowMs(),updatedAt:nowMs()});
      n++;
    }
    return n;
  }

  function parseVcf(text){
    const cards=[];
    const parts=text.split(/BEGIN:VCARD/i);
    for(const part of parts){
      if(!part || !/END:VCARD/i.test(part)) continue;
      const body=part.split(/END:VCARD/i)[0];
      const lines=body.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const card={name:"", phone:"", email:"", company:"", notes:""};
      for(const line of lines){
        const seg=line.split(":");
        if(seg.length<2) continue;
        const rawKey=seg[0].toUpperCase();
        const val=seg.slice(1).join(":").trim();
        if((rawKey==="FN"||rawKey.startsWith("FN;")) && !card.name) card.name=val;
        if(rawKey.startsWith("TEL") && !card.phone) card.phone=val.replace(/[^0-9+]/g,"");
        if(rawKey.startsWith("EMAIL") && !card.email) card.email=val;
        if((rawKey==="ORG"||rawKey.startsWith("ORG;")) && !card.company) card.company=val;
        if((rawKey==="NOTE"||rawKey.startsWith("NOTE;")) && !card.notes) card.notes=val;
      }
      if(card.name) cards.push(card);
    }
    return cards;
  }
  async function importVcfFile(file){
    const text=await file.text();
    const cards=parseVcf(text);
    if(!cards.length){ toast("VCF kosong / tidak terbaca"); return 0; }
    let n=0;
    for(const c of cards){
      const name=(c.name||"").trim();
      if(!name) continue;
      await db.put("contacts",{id:uid(),name,phone:(c.phone||"").trim()||null,email:(c.email||"").trim()||null,company:(c.company||"").trim()||null,notes:(c.notes||"").trim()||null,createdAt:nowMs(),updatedAt:nowMs()});
      n++;
    }
    return n;
  }

  async function openNewDealModal(){
    const stages=state.cache.stages, contacts=state.cache.contacts;
    const stageOptions=stages.map(s=>`<option value="${s.id}" ${s.id===state.stageId?"selected":""}>${esc(s.name)}</option>`).join("");
    const contactOptions=['<option value="">-</option>'].concat(contacts.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`)).join("");
    openModal("New Deal", `
      <div><div class="label">Deal title *</div><input id="d_title" class="input" placeholder="Contoh: Konsultan Manajemen - PT X" /></div>
      <div class="grid2" style="margin-top:10px">
        <div><div class="label">Contact (optional)</div><select id="d_contact" class="input">${contactOptions}</select></div>
        <div><div class="label">Stage</div><select id="d_stage" class="input">${stageOptions}</select></div>
        <div><div class="label">Value (optional)</div><input id="d_value" class="input" placeholder="mis. 20000000" /></div>
        <div><div class="label">Expected close (optional)</div><input id="d_close" class="input" type="date" /></div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button id="btnCreateDeal" class="primary" type="button">Create</button>
        <button id="btnCancel" class="ghost" type="button">Cancel</button>
      </div>
    `);
    $("#btnCancel").onclick=closeModal;
    $("#btnCreateDeal").onclick=async()=>{
      const title=($("#d_title").value||"").trim();
      if(!title){ toast("Title wajib"); return; }
      const contactId=($("#d_contact").value||"").trim()||null;
      const stageId=($("#d_stage").value||"").trim();
      const valueRaw=($("#d_value").value||"").trim().replaceAll(",",".");
      const value=valueRaw?Number(valueRaw):null;
      const closeStr=($("#d_close").value||"").trim();
      const expectedCloseAt=closeStr?new Date(closeStr+"T00:00:00").getTime():null;
      const id=uid();
      await db.put("deals",{id,contactId,title,stageId,status:"open",value:(Number.isFinite(value)?value:null),expectedCloseAt,wonAt:null,lostAt:null,lostReason:null,createdAt:nowMs(),updatedAt:nowMs()});
      await db.put("stageHistory",{id:uid(),dealId:id,fromStageId:null,toStageId:stageId,note:"Created",createdAt:nowMs()});
      closeModal(); await refresh(); toast("Deal created");
    };
  }

  const ordOfStage=(stageId)=>{ const s=state.cache.stages.find(x=>x.id===stageId); return s?s.ord:0; };

  async function openDealModal(dealId){
    const d=await db.get("deals",dealId);
    if(!d){ toast("Deal not found"); return; }
    const contact=d.contactId ? state.cache.contacts.find(c=>c.id===d.contactId) : null;
    const stage=d.stageId ? state.cache.stages.find(s=>s.id===d.stageId) : null;
    const stageOptions=state.cache.stages.map(s=>`<option value="${s.id}" ${s.id===d.stageId?"selected":""}>${esc(s.name)}</option>`).join("");
    const acts=state.cache.activities.filter(a=>a.dealId===d.id);
    const actHtml=acts.length?acts.map(a=>`
      <div class="item">
        <div><div class="itemTitle">${esc((a.type||"").toUpperCase())} — ${esc(a.note||"")}</div>
        <div class="itemSub">Created: ${esc(new Date(a.createdAt).toISOString())}</div></div>
        <div class="itemRight"><button class="ghost" type="button" data-act="${a.id}">${a.done?"✓ Done":"Mark done"}</button></div>
      </div>`).join("") : `<div class="empty"><div class="emptyTitle">No activities</div><div class="emptySub">Tambahkan call/meeting/task untuk tracking follow-up.</div></div>`;

    openModal("Deal Detail", `
      <div class="card" style="margin:0">
        <div class="cardTitle">${esc(d.title)}</div>
        <div class="cardSub">${esc(d.status.toUpperCase())}${d.status==="open" ? (" • Stage: "+esc(stage?stage.name:"-")):""}${contact?(" • Contact: "+esc(contact.name)):""}</div>
        ${d.status==="lost" && d.lostReason ? `<div class="hint">Lost reason: <b>${esc(d.lostReason)}</b></div>`:""}
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div><div class="label">Edit title</div><input id="ed_title" class="input" value="${esc(d.title)}" /></div>
        <div><div class="label">Value (optional)</div><input id="ed_value" class="input" value="${d.value==null?"":d.value}" /></div>
        <div><div class="label">Expected close</div><input id="ed_close" class="input" type="date" value="${d.expectedCloseAt?fmtDate(d.expectedCloseAt):""}" /></div>
        <div><div class="label">Save changes</div><button id="btnSaveDeal" class="primary" type="button">Save</button></div>
      </div>

      ${d.status==="open" ? `
        <div class="hr"></div>
        <div class="grid2">
          <div>
            <div class="label">Move stage</div>
            <select id="mv_stage" class="input">${stageOptions}</select>
            <div class="hint">Jika mundur stage, reason wajib.</div>
          </div>
          <div>
            <div class="label">Action</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnMoveStage" class="primary" type="button">Move</button>
              <button id="btnWon" class="primary" type="button">Close WON</button>
              <button id="btnLost" class="danger" type="button">Close LOST</button>
            </div>
          </div>
        </div>
      ` : ""}

      <div class="hr"></div>
      <div class="row"><div class="cardTitle">Activities</div><button id="btnAddAct" class="primary" type="button">+ Activity</button></div>
      <div id="actList">${actHtml}</div>

      <div class="hr"></div>
      <div class="row"><button id="btnClose" class="ghost" type="button">Close</button></div>
    `);

    $("#btnClose").onclick=closeModal;

    $("#btnSaveDeal").onclick=async()=>{
      const title=($("#ed_title").value||"").trim();
      if(!title){ toast("Title wajib"); return; }
      const valueRaw=($("#ed_value").value||"").trim().replaceAll(",",".");
      const value=valueRaw?Number(valueRaw):null;
      const closeStr=($("#ed_close").value||"").trim();
      const expectedCloseAt=closeStr?new Date(closeStr+"T00:00:00").getTime():null;
      await db.put("deals",{...d,title,value:(Number.isFinite(value)?value:null),expectedCloseAt,updatedAt:nowMs()});
      closeModal(); await refresh(); toast("Saved");
    };

    if(d.status==="open"){
      $("#btnMoveStage").onclick=async()=>{
        const toStageId=($("#mv_stage").value||"").trim();
        if(!toStageId || toStageId===d.stageId){ toast("Stage sama"); return; }
        const backward=ordOfStage(toStageId) < ordOfStage(d.stageId);
        let note="";
        if(backward){
          note=prompt("Reason (wajib) - mundur stage:", "");
          if(!note || !note.trim()){ toast("Reason wajib"); return; }
        } else {
          note=prompt("Note (opsional):", "") || "";
        }
        await db.put("deals",{...d,stageId:toStageId,updatedAt:nowMs()});
        await db.put("stageHistory",{id:uid(),dealId:d.id,fromStageId:d.stageId,toStageId,note:(note.trim()||null),createdAt:nowMs()});
        closeModal(); await refresh(); toast("Stage moved");
      };
      $("#btnWon").onclick=async()=>{ await db.put("deals",{...d,status:"won",wonAt:nowMs(),updatedAt:nowMs()}); closeModal(); await refresh(); toast("Closed WON"); };
      $("#btnLost").onclick=async()=>{ const reason=prompt("Lost reason (wajib):",""); if(!reason||!reason.trim()){ toast("Reason wajib"); return; } await db.put("deals",{...d,status:"lost",lostAt:nowMs(),lostReason:reason.trim(),updatedAt:nowMs()}); closeModal(); await refresh(); toast("Closed LOST"); };
    }

    $("#btnAddAct").onclick=async()=>{
      const type=prompt("Type: call / meeting / task / note","call");
      if(!type || !type.trim()) return;
      const note=prompt("Activity note (wajib):","");
      if(!note || !note.trim()){ toast("Note wajib"); return; }
      await db.put("activities",{id:uid(),dealId:d.id,type:type.trim().toLowerCase(),note:note.trim(),dueAt:null,done:0,createdAt:nowMs()});
      closeModal(); await refresh(); toast("Activity added"); openDealModal(d.id);
    };

    $$("#actList button[data-act]").forEach(btn=>{
      btn.onclick=async()=>{
        const actId=btn.getAttribute("data-act");
        const a=await db.get("activities",actId);
        if(!a) return;
        await db.put("activities",{...a,done:1});
        closeModal(); await refresh(); toast("Done"); openDealModal(d.id);
      };
    });
  }

  function exportBackup(){
    const payload={exportedAt:new Date().toISOString(),stages:state.cache.stages,contacts:state.cache.contacts,deals:state.cache.deals,activities:state.cache.activities,stageHistory:state.cache.stageHistory};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    const ts=new Date().toISOString().slice(0,16).replaceAll(":","").replaceAll("-","");
    a.href=url; a.download=`arana_crm_backup_${ts}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }
  async function restoreBackup(file){
    const text=await file.text();
    let payload; try{ payload=JSON.parse(text); } catch(e){ toast("JSON invalid"); return; }
    for(const s of ["stages","contacts","deals","activities","stageHistory"]) await db.clear(s);
    for(const s of (payload.stages||[])) await db.put("stages",s);
    for(const c of (payload.contacts||[])) await db.put("contacts",c);
    for(const d of (payload.deals||[])) await db.put("deals",d);
    for(const a of (payload.activities||[])) await db.put("activities",a);
    for(const h of (payload.stageHistory||[])) await db.put("stageHistory",h);
    await refresh();
  }

  function wireUI(){
    $$(".tab").forEach(b=>b.onclick=()=>switchTab(b.dataset.tab));
    $("#btnSync").onclick=()=>refresh();

    $("#btnNewDeal").onclick=openNewDealModal;

    $("#btnNewContact").onclick=()=>openContactModal(null);
    $("#contactSearch").addEventListener("input", ()=>renderContacts());

    $$(".segbtn").forEach(b=>{
      b.onclick=()=>{
        state.closedStatus=b.dataset.closed;
        $$(".segbtn").forEach(x=>x.classList.toggle("active", x===b));
        renderClosed();
      };
    });

    $("#btnAddStage").onclick=async()=>{
      const name=($("#newStageName").value||"").trim();
      if(!name){ toast("Nama stage wajib"); return; }
      const ord=state.cache.stages.length ? Math.max(...state.cache.stages.map(s=>s.ord))+1 : 0;
      await db.put("stages",{id:uid(),name,ord});
      $("#newStageName").value="";
      await refresh(); toast("Stage added");
    };

    $("#btnImportCsv").onclick=async()=>{
      const file=$("#csvFile").files && $("#csvFile").files[0];
      if(!file){ toast("Pilih file CSV dulu"); return; }
      const n=await importCsvFile(file);
      await refresh(); toast(`Imported: ${n} contact(s)`);
    };
    $("#btnImportVcf").onclick=async()=>{
      const file=$("#vcfFile").files && $("#vcfFile").files[0];
      if(!file){ toast("Pilih file VCF dulu"); return; }
      const n=await importVcfFile(file);
      await refresh(); toast(`Imported: ${n} contact(s)`);
    };

    $("#btnExport").onclick=exportBackup;
    $("#btnRestore").onclick=async()=>{
      const file=$("#jsonFile").files && $("#jsonFile").files[0];
      if(!file){ toast("Pilih file JSON backup"); return; }
      if(!confirm("Restore akan overwrite semua data. Lanjut?")) return;
      await restoreBackup(file); toast("Restored");
    };
  }

  (async function main(){
    try{
      await db.open();
      await seedIfEmpty();
      await loadCache();
      wireUI();
      render();
    }catch(e){
      // Show banner if critical error
      const b=document.getElementById("jsBanner");
      b.classList.remove("hidden");
      b.innerHTML = "<b>Error JS:</b> " + esc(String(e)) + "<br/>Coba buka <code>reset.html</code> lalu reload.";
      console.error(e);
    }
  })();
</script>
</body>
</html>
